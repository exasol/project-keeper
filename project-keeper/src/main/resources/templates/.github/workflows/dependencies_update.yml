# Generated by Project Keeper
# https://github.com/exasol/project-keeper/blob/main/project-keeper/src/main/resources/templates/.github/workflows/dependencies_update.yml
name: Update dependencies
on:
  workflow_call:
    inputs:
      vulnerability_issues:
        description: "GitHub issues for vulnerable dependencies as JSONL"
        required: false
        type: string
  workflow_dispatch:

jobs:
  update_dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDKs
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: |
            11
            17
          cache: "maven"

      - name: Print issues
        run: |
          echo "Issues from Action input: $ISSUES"
        shell: bash
        env:
          ISSUES: ${{ inputs.vulnerability_issues }}

      - name: Fail if not running on a branch
        if: ${{ !startsWith(github.ref, 'refs/heads/') }}
        uses: actions/github-script@v7
        with:
          script: |
            core.setFailed('Not running on a branch, github.ref is ${{ github.ref }}. Please start this workflow only on main or a branch')

      - name: Update dependencies (TODO)
        shell: bash
        run: |
          echo "Updating dependencies..."
          echo "Updating changelog for $CREATED_ISSUES"
          echo "File updated $(date)" >> README.md
          echo "Issues: $CREATED_ISSUES" >> README.md
          echo >> README.md
        env:
          CREATED_ISSUES: ${{ inputs.vulnerability_issues }}

      - name: Generate PR comment
        id: pr-comment
        shell: bash
        run: |
          echo 'comment<<EOF' >> "$GITHUB_OUTPUT"
          echo 'This Pull Request was created by `dependencies_update.yml` workflow' >> "$GITHUB_OUTPUT"
          echo $CREATED_ISSUES | jq --raw-output '. | "Closes " + .issue_url + " (" + .cve + ")"' >> "$GITHUB_OUTPUT"
          echo 'EOF' >> "$GITHUB_OUTPUT"
        env:
          CREATED_ISSUES: ${{ inputs.vulnerability_issues }}

      - name: Configure git
        shell: bash
        run: |
          git config --global user.email "opensource@exasol.com"
          git config --global user.name "Automatic Dependency Updater"

      - name: Create branch
        if: ${{ github.ref == 'refs/heads/main' }}
        shell: bash
        run: |
          branch_name="dependency-update/$(date "+%Y%m%d%H%M%S")"
          echo "Creating branch $branch_name"
          git checkout -b "$branch_name"

      - name: Commit changes & push
        if: ${{ startsWith(github.ref, 'refs/heads/' ) }}
        shell: bash
        run: |
          branch_name=$(git rev-parse --abbrev-ref HEAD)
          echo "Current branch: $branch_name, local changes:"
          git diff --stat
          git diff --numstat
          echo "Committing changes..."
          git commit --all --message "Update dependencies"
          echo "Pushing branch $branch_name..."
          git push --set-upstream origin $branch_name
          echo "Done."

      - name: Create pull request
        if: ${{ github.ref == 'refs/heads/main' }}
        shell: bash
        run: |
          gh pr create --base main --title "Update dependencies" --body "$COMMENT"
        env:
          COMMENT: ${{ steps.pr-comment.outputs.comment }}
          GH_TOKEN: ${{ github.token }}
